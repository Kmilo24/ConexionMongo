#!/usr/bin/env node

const path = require('path')
const args = require('./prompt')
const {
  getFinalPrompt,
  exit,
  copyTemplate,
  write,
  copyTemplateMulti,
  confirm,
  mkdir,
  createAppName,
  emptyDirectory,
  getFuncBody,
  loadTemplate,
  prettyJson
} = require('./utils')

const { createPackage, addDependency } = require('./package-tmpl')
const getWorkingDir = () => path.resolve(args.args.shift() || '.')

// Re-assign process.exit because of commander
process.exit = exit
if (!exit.exited) {
  main()
}

const dir = getWorkingDir()
const renderFeature = (name, srcDir = undefined, finalName = undefined) => {
  const parentName = srcDir || name
  const feat = loadTemplate(`js/${parentName}/${name}.js`)
  feat.locals.args = args
  write(path.join(dir, `${finalName || name}.js`), feat.render())
}

let name = args.title
if (args.add) {
  switch (args.add) {
    case 'pass':
      renderFeature('pass', 'auth')
      break
    case 'rest':
      name = name || 'entity'
      renderFeature('ctrl', 'rest', `${name}-ctrl`)
      renderFeature('model', 'rest', `${name}-model`)
      renderFeature('test', 'rest', `${name}-test`)
      break
    case 'test':
      renderFeature('test', 'rest', `${name}-test`)
      break
    case 'app':
      name = name || 'new-app'
      renderFeature('new-app', 'router', `${name}-app`)
      break
    case 'aggregate':
      name = name || 'aggregate'
      renderFeature(args.add, 'router', `${name}-aggregate`)
      break
    case 'secure-validate':
      renderFeature('validate', 'secure', `${name}-validate`)
      break
    case 'csrf-origin-check':
      renderFeature('csrf-origin-check', 'secure', `csrf-origin-check`)
      break
    case 'secure-brute-force':
      renderFeature('brute-force', 'secure', `${name}-brute-force`)
      break
    case 'net-proxy':
      name = name || ''
      renderFeature('net-proxy', 'proxy', `${name}-net-proxy`)
      break
    case 'cors':
      name = name || ''
      renderFeature('cors', 'middle', `${name}-cors`)
      break
    case 'proxy':
    case 'cookie':
    case 'router':
    case 'upload':
    case 'secure':
      const srcName = args.add
      const srcPath = srcName
      const destName = name ? `${name}-${args.add}` : args.add
      renderFeature(srcName, srcPath, destName)
      break
    default:
      console.error('Unknown generator', args.add)
  }
  process.exit(0)
}

function createApplication(_name, _dir) {
  const use = (cb) => {
    app.locals.uses.push(getFuncBody(cb).trim())
  }
  const addImport = (pname, alias = undefined, version = undefined) => {
    const finalName = alias || pname
    addDependency(pkg, pname)
    app.locals.modules[finalName] = pname
  }
  const initApp = (app) => {
    const locals = app.locals
    Object.assign(locals, {
      localModules: Object.create(null),
      modules: Object.create(null),
      mounts: [],
      uses: [],
      args
    })
  }

  const pkg = createPackage(_name)
  const app = loadTemplate('js/app.js')
  initApp(app)

  // Request logger
  addImport('morgan', 'logger')
  use((logger) => logger('dev'))

  // Parsers
  use((express) => express.json())
  use((express) => express.urlencoded({ extended: false }))
  addImport('cookie-parser', 'cookieParser')
  use((cookieParser) => cookieParser())
  use((express) => express.static(path.join(__dirname, 'public')))

  if (_dir !== '.') {
    mkdir(_dir, '.')
  }

  if (args.view) {
    mkdir(_dir, 'views')
    copyTemplateMulti('views', `${_dir}/views`, '*.ejs')
    app.locals.view = { engine: 'ejs' }
    addDependency(pkg, 'ejs')
  }

  write(path.join(_dir, 'app.js'), app.render())
  write(path.join(_dir, 'package.json'), prettyJson(pkg))
  // copy assets
  copyTemplate('js/readme/curl.md', path.join(_dir, 'curl.md'))
  copyTemplate('js/gitignore', path.join(_dir, '.gitignore'))
  copyTemplate('js/jest.config.js', path.join(_dir, 'jest.config.js'))
  console.log(getFinalPrompt(_dir))
}

function main() {
  const destinationPath = getWorkingDir()
  const appName = createAppName(destinationPath) || 'hello-world'
  args.view = args.view === true ? 'ejs' : undefined

  emptyDirectory(destinationPath, (empty) => {
    const newApp = () => createApplication(appName, destinationPath)
    if (empty || args.force) {
      newApp()
    } else {
      confirm('???OVERWRITE???? [y/N] ', (ok) => {
        if (ok) {
          process.stdin.destroy()
          newApp()
        } else {
          console.error('ABORTING')
          exit(1)
        }
      })
    }
  })
}
